{% extends 'base.html' %}

{% block content %}


<!-- Main App Workspace -->
<section id="app-workspace" class="workspace-section">
    <header class="app-header">
        <div class="header-top">
            <h2 class="workspace-title">My Space</h2>
            <div class="header-controls">
                <a href="{{ url_for('view_bin') }}" class="nav-item-vertical" title="Recycle Bin">
                    <i data-lucide="trash-2"></i>
                    <span class="nav-label">Recycle Bin</span>
                </a>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="search-bar">
            <i data-lucide="search" class="search-icon"></i>
            <input type="text" id="search-input" placeholder="Search your notes..." autocomplete="off">
        </div>

        <!-- Label Bar (Horizontal Scroll) -->
        <div class="label-bar-container">
            <div class="label-bar" id="label-bar">
                {% if tags %}
                {% for tag in tags %}
                <button class="filter-chip" data-id="{{ tag.id }}"
                    onclick="labelController.toggleFilter({{ tag.id }}, this)">
                    {{ tag.name }}
                </button>
                {% endfor %}
                {% endif %}

                <!-- Add Label Button -->
                <button class="btn-add-label" onclick="labelController.promptCreate()" title="New Label">
                    <i data-lucide="plus"></i>
                </button>
            </div>

            <!-- Clear Filters (Visible when active) -->
            <button class="btn-clear-filters" id="btn-clear-filters" onclick="labelController.clearFilters()"
                title="Clear Selection">
                <i data-lucide="x"></i>
            </button>
        </div>

        <!-- Input Area (New Note) -->
        <div class="input-area glass-panel">
            <form action="{{ url_for('add') }}" method="POST" id="addForm">
                <input type="text" name="title" placeholder="Title" class="input-title" autocomplete="off">
                <textarea name="content" placeholder="Take a note..." class="input-content"></textarea>

                <!-- Media Preview for New Note -->
                <div id="new-media-preview-area" class="media-preview-list"></div>

                <div class="form-actions">
                    <div class="action-left">
                        <button type="button" class="btn-icon" id="btn-upload-trigger" title="Add Image">
                            <i data-lucide="image"></i>
                        </button>
                        <input type="file" id="file-input" accept="image/png, image/jpeg, image/webp"
                            style="display: none;" multiple>
                    </div>
                    <input type="hidden" name="media_json" id="media-json">

                    <button type="submit" class="btn-add">Add</button>
                </div>
            </form>
        </div>
    </header>

    <main class="notes-grid" id="notesGrid">
        {% if items %}
        {% for item in items %}
        <!-- Single Card Structure (Flat) -->
        <div class="card item-card {% if item.pinned %}pinned{% endif %}" data-id="{{ item.id }}">

            <!-- Pin Action -->
            <button class="btn-pin {{ 'active' if item.pinned else '' }}"
                onclick="togglePin({{ item.id }}, {{ 'false' if item.pinned else 'true' }})"
                title="{{ 'Unpin' if item.pinned else 'Pin' }}">
                <i data-lucide="pin" class="{{ 'filled' if item.pinned else '' }}"></i>
            </button>

            <!-- Capture Outer Loop Index for Lazy Loading Logic -->
            {% set outer_loop_index = loop.index %}

            {% if item.media %}
            <div class="card-media">
                {% for m in item.media %}
                <div class="media-item">
                    {% if m.type == 'image' %}
                    <img src="{{ m.thumbnail_url if m.thumbnail_url else m.url }}" alt="Attachment"
                        loading="{{ 'eager' if outer_loop_index <= 3 else 'lazy' }}" {% if outer_loop_index==1
                        %}fetchpriority="high" {% endif %}>
                    {% elif m.type == 'video' %}
                    <div class="video-container">
                        <iframe src="{{ m.url }}" frameborder="0" allowfullscreen></iframe>
                    </div>
                    {% endif %}

                    <!-- Media Controls -->
                    <div class="media-overlay">
                        <button class="btn-media-action btn-remove-media-edit" title="Remove"
                            data-note-id="{{ item.id }}" data-media-id="{{ m.id }}">
                            <i data-lucide="x"></i>
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Dynamic Content Visibility -->
            {% set has_text = item.title or (item.content and item.content | striptags | trim | length > 0) or item.tags
            %}
            <div class="card-content {% if not has_text and item.media %}hidden-content{% endif %}">
                <h3 class="item-title" contenteditable="true" data-field="title">{{ item.title }}</h3>
                <div class="item-body" contenteditable="true" data-field="content">{{ item.content | safe }}</div>
                <div class="tags-container">
                    {% for tag in item.tags %}
                    <span class="tag-chip" data-id="{{ tag.id }}" onclick="setSearch('{{ tag.name }}', event)">{{
                        tag.name }}</span>
                    {% endfor %}
                </div>
            </div>

            <div class="card-meta">
                <span class="created-date">Created on: {{ item.created_at.strftime('%d %b %Y Â· %I:%M %p') }}</span>
            </div>

            <div class="card-actions hover-actions">
                <button type="button" class="btn-icon" onclick="handleAddText(this, {{ item.id }})" title="Add Text">
                    <i data-lucide="type"></i>
                </button>
                <button type="button" class="btn-icon" onclick="triggerAddImage({{ item.id }})" title="Add Image">
                    <i data-lucide="image-plus"></i>
                </button>
                <form action="{{ url_for('soft_delete', item_id=item.id) }}" method="POST" class="delete-form"
                    onsubmit="event.preventDefault(); deleteNoteInline(this, {{ item.id }});">
                    <button type="submit" class="btn-icon btn-delete" title="Delete">
                        <i data-lucide="trash-2"></i>
                    </button>
                </form>
            </div>

        </div>
        {% endfor %}
        {% else %}
        <div class="empty-state">
            <i data-lucide="sparkles" size="64"></i>
            <p>Your space is empty. Start by adding a task.</p>
        </div>
        {% endif %}
    </main>

    </main>
</section>

</section>

<!-- Note Detail Modal -->
<div id="note-modal-overlay" class="modal-overlay">
    <div class="modal-content" id="note-modal-content">
        <button class="btn-close-modal" onclick="closeNoteModal()"><i data-lucide="x"></i></button>
        <div id="modal-card-container"></div>

        <!-- EDITOR TOOLBAR -->
        <div class="editor-toolbar" id="editor-toolbar">
            <button data-cmd="bold" title="Bold"><i data-lucide="bold"></i></button>
            <button data-cmd="italic" title="Italic"><i data-lucide="italic"></i></button>
            <button data-cmd="underline" title="Underline"><i data-lucide="underline"></i></button>
            <div style="height: 1px; background: #eee; margin: 4px 6px;"></div>
            <button id="btn-checklist" title="Checklist"><i data-lucide="check-square"></i></button>
            <button data-cmd="insertUnorderedList" title="List"><i data-lucide="list"></i></button>
            <div style="height: 1px; background: #eee; margin: 4px 6px;"></div>
            <button id="btn-open-drawing" title="Sketch"><i data-lucide="pen-tool"></i></button>
            <button id="btn-toolbar-image" title="Add Image"><i data-lucide="image"></i></button>
            <div style="height: 1px; background: #eee; margin: 4px 6px;"></div>
            <button id="btn-show-tags" title="Tags"><i data-lucide="tag"></i></button>
        </div>

        <!-- TAG POPOVER -->
        <div class="tag-popover" id="tag-popover">
            <input type="text" class="tag-input" id="tag-input" placeholder="Tag name..." autocomplete="off">
            <div class="tag-suggestions" id="tag-suggestions"></div>
        </div>
    </div>
</div>

<!-- Global Hidden Input for Edit Mode -->
<input type="file" id="edit-file-input" accept="image/png, image/jpeg, image/webp" style="display: none;" multiple>


</div>

<!-- Create Label Modal -->
<div id="create-label-modal" class="modal-overlay">
    <div class="modal-content label-modal-content glass-panel">
        <div class="modal-header">
            <h3 class="modal-title">Create New Label</h3>
            <button class="btn-close-modal-small" onclick="labelController.closeCreateModal()">
                <i data-lucide="x"></i>
            </button>
        </div>

        <div class="modal-body">
            <div class="input-group">
                <input type="text" id="new-label-input" class="label-input-large" placeholder="Enter label name..."
                    autocomplete="off">
            </div>

            <div class="note-selection-section">
                <div class="section-header">
                    <h4 class="section-title">Add to existing notes:</h4>
                    <div class="search-wrapper">
                        <i data-lucide="search" class="search-icon-small"></i>
                        <input type="text" id="note-search-input" placeholder="Search notes..."
                            onkeyup="labelController.filterNotes()">
                    </div>
                </div>

                <div class="selection-controls">
                    <label class="checkbox-wrapper">
                        <input type="checkbox" id="select-all-checkbox" onchange="labelController.toggleSelectAll()">
                        <span class="checkmark"></span>
                        <span class="label-text">Select All</span>
                    </label>
                    <span id="selected-count" class="selected-count">0 selected</span>
                </div>

                <div class="note-selection-list custom-scrollbar" id="note-selection-list">
                    <!-- Checkboxes injected by JS -->
                </div>
            </div>
        </div>

        <div class="modal-actions">
            <button class="btn-cancel" onclick="labelController.closeCreateModal()">Cancel</button>
            <button class="btn-confirm" onclick="labelController.confirmCreate()">Create Label</button>
        </div>
    </div>
</div>


<script>
    function scrollToApp() {
        document.getElementById('app-workspace').scrollIntoView({ behavior: 'smooth' });
    }
    // Inline delete handler
    function deleteNoteInline(form, id) {
        if (!confirm('Delete this note?')) return;
        fetch(form.action, { method: 'POST' })
            .then(() => {
                const card = form.closest('.card');
                if (card) card.remove();
            });
    }
</script>
<!-- Drawing Modal (Restored) -->
<div id="drawing-modal" class="drawing-modal">
    <!-- Top Actions (Apple Style) -->
    <div class="drawing-header">
        <button class="btn-drawing-cancel" onclick="closeDrawingModal()">Cancel</button>
        <div class="drawing-title">Markup</div>
        <button id="btn-save-drawing" class="btn-drawing-done">Done</button>
    </div>

    <!-- Canvas -->
    <canvas id="drawing-canvas"></canvas>

    <!-- Bottom Markup Dock -->
    <div class="markup-dock">
        <!-- Left Controls (Undo/Redo) -->
        <div class="dock-group left-controls">
            <button class="icon-btn" id="btn-undo" title="Undo"><i data-lucide="undo-2"></i></button>
            <button class="icon-btn" id="btn-redo" title="Redo"><i data-lucide="redo-2"></i></button>
        </div>

        <div class="separator-vertical"></div>

        <div class="markup-tools">
            <!-- Pen -->
            <div class="tool-item active" data-tool="pen" title="Pen">
                <div class="tool-graphic pen-graphic">
                    <div class="tool-cap"></div>
                    <div class="tool-barrel"></div>
                    <div class="tool-tip"></div>
                </div>
            </div>

            <!-- Marker (Highlighter) -->
            <div class="tool-item" data-tool="marker" title="Highlighter">
                <div class="tool-graphic marker-graphic">
                    <div class="tool-cap"></div>
                    <div class="tool-barrel"></div>
                    <div class="tool-tip"></div>
                </div>
            </div>

            <!-- Fine Tip (Sharpie) -->
            <div class="tool-item" data-tool="finetip" title="Fine Tip">
                <div class="tool-graphic finetip-graphic">
                    <div class="tool-cap"></div>
                    <div class="tool-barrel"></div>
                    <div class="tool-tip"></div>
                </div>
            </div>

            <!-- Crayon -->
            <div class="tool-item" data-tool="crayon" title="Crayon">
                <div class="tool-graphic crayon-graphic">
                    <div class="tool-wrapper"></div>
                    <div class="tool-tip"></div>
                </div>
            </div>

            <!-- Calligraphy -->
            <div class="tool-item" data-tool="calligraphy" title="Calligraphy">
                <div class="tool-graphic calligraphy-graphic">
                    <div class="tool-cap"></div>
                    <div class="tool-barrel"></div>
                    <div class="tool-tip"></div>
                </div>
            </div>

            <!-- Watercolor -->
            <div class="tool-item" data-tool="watercolor" title="Watercolor">
                <div class="tool-graphic watercolor-graphic">
                    <div class="tool-bristles"></div>
                    <div class="tool-barrel"></div>
                </div>
            </div>

            <!-- Pencil -->
            <div class="tool-item" data-tool="pencil" title="Pencil">
                <div class="tool-graphic pencil-graphic">
                    <div class="tool-cap"></div>
                    <div class="tool-barrel"></div>
                    <div class="tool-tip"></div>
                </div>
            </div>

            <!-- Eraser -->
            <div class="tool-item" data-tool="eraser" title="Eraser">
                <div class="tool-graphic eraser-graphic">
                    <div class="tool-body"></div>
                </div>
            </div>
            <!-- Ruler -->
            <div class="tool-item" data-tool="ruler" title="Ruler">
                <div class="tool-graphic ruler-graphic">
                    <div class="ruler-markings"></div>
                </div>
            </div>
        </div>

        <div class="separator-vertical"></div>

        <div class="markup-colors">
            <button class="color-swatch active" style="--swatch-color: #1a1a1a" data-color="#1a1a1a"></button>
            <button class="color-swatch" style="--swatch-color: #007aff" data-color="#007aff"></button>
            <button class="color-swatch" style="--swatch-color: #34c759" data-color="#34c759"></button>
            <button class="color-swatch" style="--swatch-color: #ffcc00" data-color="#ffcc00"></button>
            <button class="color-swatch" style="--swatch-color: #ff3b30" data-color="#ff3b30"></button>
            <button class="color-swatch" style="--swatch-color: #ffffff" data-color="#ffffff"></button>
        </div>

        <div class="separator-vertical"></div>

        <!-- Right Controls (Plus/Menu) -->
        <div class="dock-group right-controls">
            <button class="icon-btn"><i data-lucide="plus"></i></button>
            <button class="icon-btn"><i data-lucide="more-horizontal"></i></button>
        </div>
    </div>
</div>
{% endblock %}